!function(){"use strict";function t(t,e,n,o,a,i,l,r){var s,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=n,c._compiled=!0),o&&(c.functional=!0),i&&(c._scopeId="data-v-"+i),l?(s=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),a&&a.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(l)},c._ssrRegister=s):a&&(s=r?function(){a.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:a),s)if(c.functional){c._injectStyles=s;var d=c.render;c.render=function(t,e){return s.call(e),d(t,e)}}else{var p=c.beforeCreate;c.beforeCreate=p?[].concat(p,s):[s]}return{exports:t,options:c}}const e={};var n=t({data:()=>({map:null,attachedMarker:[],attachedPopup:[],options:null}),computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center)return[0,20];const t=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:e,lat:n,lng:o}=this.content.center;return t.defaultName=e,t.defaultLat=n,t.defaultLng=o,[o,n]},marker(){return this.content.marker.map((({content:t})=>{var e,n,o,a,i,l,r,s,c,d,p,u,h,m;const f=null!=(a=null==(o=null==(n=null==(e=t.image)?void 0:e[0])?void 0:n.info)?void 0:o.split(" Ã— "))?a:[0,0];return{image:null==(l=null==(i=t.image)?void 0:i[0])?void 0:l.url,width:f[0]/100*t.size,height:f[1]/100*t.size,lat:null!=(d=null!=(c=null==(r=t.coordinates)?void 0:r.lat)?c:null==(s=t.coors)?void 0:s.lat)?d:0,lng:null!=(m=null!=(h=null==(p=t.coordinates)?void 0:p.lng)?h:null==(u=t.coors)?void 0:u.lng)?m:51,anchor:t.anchor,hasPopup:t.haspopup,popup:t.popup,popupOffset:t.popupoffset}}))}},watch:{"content.style":function(t){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${t}`)},"content.zoom":function(t){this.map&&this.map.setZoom(t)},center(t){this.map&&this.map.setCenter(t)},marker(t){this.attachedPopup.forEach((t=>t.remove())),this.attachedPopup=[],this.attachedMarker.forEach((t=>t.remove())),this.attachedMarker=[],this.setMarker(t)}},created(){const t="https://api.mapbox.com/mapbox-gl-js/v2.3.1";let e;const n="mapbox-gl.css";document.getElementById(n)||(e=document.createElement("link"),e.id=n,e.href=`${t}/${n}`,e.rel="stylesheet",document.head.appendChild(e));const o="mapbox-gl.js";document.getElementById(o)?this.initMap():(e=document.createElement("script"),e.id=o,e.addEventListener("load",this.initMap),e.src=`${t}/${o}`,document.body.appendChild(e))},methods:{async initMap(){var t,e;const n=await this.$api.get("map/options");this.options=n,mapboxgl.accessToken=this.options.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:`mapbox://styles/mapbox/${null!=(t=this.content.style)?t:this.options.defaultStyle}`,zoom:null!=(e=this.content.zoom)?e:1}),this.map.scrollZoom.disable(),this.setMarker(this.marker)},async setMarker(t){var e;if(t)for(const n of t){let t=null;n.image&&(t=document.createElement("div"),t.className="marker",t.style.backgroundImage=`url(${n.image})`,t.style.width=`${n.width}px`,t.style.height=`${n.height}px`,t.style.backgroundSize="100%");const o=new mapboxgl.Marker({anchor:null!=(e=n.anchor)?e:null,element:t}).setLngLat([n.lng,n.lat]).addTo(this.map);if(this.attachedMarker.push(o),n.hasPopup){const t=new mapboxgl.Popup({offset:parseInt(n.popupOffset),focusAfterOpen:!1});t.setLngLat([n.lng,n.lat]),t.setHTML(n.popup).addTo(this.map),this.attachedPopup.push(t)}}}}},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"embedded-maps"},[n("div",{staticClass:"embedded-map-item",attrs:{id:t.mapId},on:{update:t.update}})])}),[],!1,o,null,null,null);function o(t){for(let n in e)this[n]=e[n]}var a=function(){return n.exports}();const i={};var l=t({computed:{url(){var t,e,n;return null==(n=null==(e=null==(t=this.content.image)?void 0:t[0])?void 0:e.icon)?void 0:n.url},description(){var t,e,n;return null!=(n=null==(t=this.content.coordinates)?void 0:t.name)?n:null==(e=this.content.coors)?void 0:e.name},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from new.)":null}}},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"marker-item",on:{click:t.open}},[t.url?n("div",{staticClass:"marker-item-image"},[n("img",{attrs:{src:t.url}})]):t._e(),n("div",{staticClass:"marker-item-description"},[n("p",[t._v(t._s(t.description||t.$t("empty")))]),n("p",[t._v(t._s(t.coordinates))])])])}),[],!1,r,null,null,null);function r(t){for(let e in i)this[e]=i[e]}var s=function(){return l.exports}();const c={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default:()=>({name:void 0,lat:void 0,lng:void 0})},required:Boolean,disabled:Boolean,default:{type:Object,default:()=>({name:"",lat:0,lng:0})}},data:()=>({geoData:[],error:null}),computed:{mapId(){return`map-${this._uid}`},location(){var t,e,n,o,a,i,l,r,s,c,d,p;return{name:null!=(o=null!=(n=null==(t=this.value)?void 0:t.name)?n:null==(e=this.default)?void 0:e.name)?o:"",lat:null!=(r=null!=(l=null==(a=this.value)?void 0:a.lat)?l:null==(i=this.default)?void 0:i.lat)?r:0,lng:null!=(p=null!=(d=null==(s=this.value)?void 0:s.lng)?d:null==(c=this.default)?void 0:c.lng)?p:0}},dropdownOptions(){return this.geoData.map((({place_name:t,place_type:e,center:n})=>({name:t,type:e[0],lat:n[1],lng:n[0]})))}},methods:{async searchLocation(t){if(t)try{const e=await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${t}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`),n=await e.json();if(this.error=null,n.features){const t=n.features.slice(0,6);t?(this.geoData=t,this.$refs.dropdown.open()):(this.error=this.$t("maps.field.L.error.empty"),this.$refs.dropdown.close())}else this.error=n.message,this.$refs.dropdown.close()}catch(e){this.$refs.dropdown.close()}else this.$refs.dropdown.close()},selectDropdown(t){delete t.type,this.$refs.dropdown.close(),this.$emit("input",t)},setValue(t,e){let n={name:"name"===e?t:this.location.name,lat:"lat"===e?t:this.location.lat,lng:"lng"===e?t:this.location.lng};!this.required||n.name&&n.lat&&n.lng?n.name?!n.lat||isNaN(n.lat)||Math.abs(n.lat)>90?this.error=this.$t("maps.field.geolocation.lat.error"):!n.lng||isNaN(n.lng)||Math.abs(n.lng)>180?this.error=this.$t("maps.field.geolocation.lng.error"):(this.error=null,this.$emit("input",n)):this.error=this.$t("maps.field.geolocation.lat.error"):this.error=this.$t("maps.field.geolocation.error")}}},d={};var p=t(c,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("k-field",{staticClass:"k-geolocation-field",attrs:{label:t.label,required:t.required,disabled:t.disabled}},[n("k-text-field",{ref:"name",staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",value:t.search,icon:"search"},on:{input:t.searchLocation}}),n("k-dropdown",[n("k-dropdown-content",{ref:"dropdown"},t._l(t.dropdownOptions,(function(e,o){return n("k-dropdown-item",{key:o,on:{click:function(n){return t.selectDropdown(e)}},nativeOn:{keydown:[function(n){return!n.type.indexOf("key")&&t._k(n.keyCode,"enter",13,n.key,"Enter")?null:(n.preventDefault(),t.selectDropdown(e))},function(n){return!n.type.indexOf("key")&&t._k(n.keyCode,"space",32,n.key,[" ","Spacebar"])?null:(n.preventDefault(),t.selectDropdown(e))}]}},[n("span",{domProps:{innerHTML:t._s(t.$t("maps.field.geolocation."+e.type)+": "+e.name)}})])})),1)],1),n("k-input",{ref:"name",attrs:{type:"text",theme:"field",value:t.location.name,before:t.$t("maps.field.geolocation.name")},on:{input:function(e){return t.setValue(e,"name")}}}),n("k-input",{ref:"lat",attrs:{type:"text",theme:"field",value:t.location.lat,before:t.$t("maps.field.geolocation.lat")},on:{input:function(e){return t.setValue(e,"lat")}}}),n("k-input",{ref:"lng",attrs:{type:"text",theme:"field",value:t.location.lng,before:t.$t("maps.field.geolocation.lng")},on:{input:function(e){return t.setValue(e,"lng")}}}),t.error?n("k-box",{attrs:{text:t.$t(t.error),theme:"negative"}}):t._e()],1)}),[],!1,u,null,null,null);function u(t){for(let e in d)this[e]=d[e]}var h=function(){return p.exports}();window.panel.plugin("microman/map",{icons:{marker:'<path d="M7.3,15.6C2.8,9.1,2,8.4,2,6.1c0-3.3,2.7-5.9,5.9-5.9s5.9,2.7,5.9,5.9c0,2.4-0.8,3.1-5.3,9.6C8.3,16.1,7.6,16.1,7.3,15.6L7.3,15.6z M7.9,8.5c1.4,0,2.5-1.1,2.5-2.5S9.3,3.6,7.9,3.6S5.5,4.7,5.5,6.1S6.6,8.5,7.9,8.5z"/>'},blocks:{marker:s,maps:a},fields:{geolocation:h}})}();
